
@startuml
title KYC – Business Data Model (Simplified for stakeholders)\n(Party • Blocks SCD2 • Hit • ReviewInstance • Family • Targets)

hide methods
skinparam linetype ortho
skinparam classAttributeIconSize 0

' ======== CORE ========
class Party {
  +id: String
  +externalRef: String
  +type: String
  +subType: String
}

' ======== BLOCKS (SCD2) ========
class Block {
  +id: String
  +kind: String                ' e.g. STATIC_DATA, DOCUMENTS, NAME_SCREENING
  --
  +partyId: String            ' -> Party.id (owner)
}

class BlockVersion {
  +id: String
  +blockId: String            ' -> Block.id
  +versionNo: int
  +validFrom: DateTime
  +validTo: DateTime?
  +status: String             ' IN_REVIEW | PENDING_AGENT | APPROVED | REJECTED
  +dataJson: String
}

class "<<View>> CurrentBlockV" as CurrentBlockV {
  +blockVersionId: String
  +blockId: String
  +partyId: String
  +kind: String
  +versionNo: int
  +effectiveFrom: DateTime
}

Party "1" o-- "0..*" Block : owns >
Block "1" o-- "0..*" BlockVersion : versions >
CurrentBlockV ..> BlockVersion : <<derives>>

note right of Block
  Rule: UNIQUE (partyId, kind)\n→ One Block per Kind for a Party
end note

note right of BlockVersion
  SCD2: at most one current per Block\n(validTo = NULL)\n\nOptional DB rule (denormalized):\nUNIQUE (partyId, kind, versionNo)
end note

' ======== HITS ========
class Hit {
  +id: String
  +partyId: String            ' -> Party.id (concerned)
  +hitType: String
  +occurredAt: DateTime
  +payloadJson: String
}
Party "1" o-- "0..*" Hit : has >

' ======== REVIEW (process, no aggregate statuses) ========
class ReviewInstance {
  +id: String
  +hitId: String?             ' -> Hit.id (optional)
  +pivotPartyId: String       ' -> Party.id
  +startedAt: DateTime
  +closedAt: DateTime?
  +notes: String?
}
Hit "1" o-- "0..1" ReviewInstance : triggers >
Party "1" o-- "0..*" ReviewInstance : as pivot >

' ======== FAMILY (captured per instance) ========
class ReviewMember {
  +id: String
  +reviewId: String           ' -> ReviewInstance.id
  +memberPartyId: String      ' -> Party.id
  +relationType: String       ' e.g. MANDATAIRE, CO_HOLDER, LEGAL_REP
  +addedAt: DateTime
}
ReviewInstance "1" o-- "0..*" ReviewMember : includes >
Party "1" o-- "0..*" ReviewMember : as member >

' ======== TARGETS (work items) ========
class ReviewTarget {
  +reviewId: String           ' -> ReviewInstance.id
  +targetPartyId: String      ' -> Party.id (pivot or member)
  +blockKind: String          ' e.g. DOCUMENTS, NAME_SCREENING
  +blockVersionId: String?    ' -> BlockVersion.id (when finalized)
  --
  ' Logical PK: (reviewId, targetPartyId, blockKind)
}
ReviewInstance "1" o-- "0..*" ReviewTarget : targets >
Party "1" o-- "0..*" ReviewTarget : as targetParty >
BlockVersion "1" o-- "0..*" ReviewTarget : may finalize >

' ======== CONFIG (business rules) ========
class RelationTypeBlockScope {
  +id: String
  +relationType: String
  +blockKind: String
  +isRequired: boolean
  +policyCode: String?
}
RelationTypeBlockScope ..> ReviewMember : defines required blockKinds
RelationTypeBlockScope ..> ReviewTarget : filters by blockKind

' ======== SHORT NOTES ========
note bottom of ReviewMember
Family is fixed when the ReviewInstance starts.\nNo statuses stored at Party/Member/Instance level in this view.
end note

note right of ReviewTarget
A target = (instance, target party, block kind).\nIt optionally points to the BlockVersion used when finalized.
end note

@enduml
